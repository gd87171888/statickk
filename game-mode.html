<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">
    <meta name="description" content="é’¢ç´èŠ‚å¥æ¸¸æˆ - ç±»ä¼¼ Synthesia å’Œ Piano Tiles çš„è½é”®éŸ³æ¸¸">
    <meta name="theme-color" content="#6A0DAD">
    <title>ğŸ® é’¢ç´èŠ‚å¥æ¸¸æˆ - è½é”®æŒ‘æˆ˜</title>
    <link rel="shortcut icon" href="./favicon.png">
    <link href="./static/css/share.min.css" rel="stylesheet">
    <link href="./static/css/nav-bar.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        .game-container {
            width: 100%;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .game-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .score-display {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.8;
            display: block;
        }

        .score-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
        }

        .combo-value {
            color: #FF6B6B;
        }

        .accuracy-value {
            color: #51CF66;
        }

        .game-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
        }

        .progress-bar-wrapper {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* æ¸¸æˆç”»å¸ƒåŒºåŸŸ */
        .game-canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* åˆ¤å®šåé¦ˆ */
        .judgment-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 50;
            animation: judgmentPop 0.5s ease-out;
            opacity: 0;
        }

        @keyframes judgmentPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        .judgment-perfect {
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700;
        }

        .judgment-good {
            color: #51CF66;
            text-shadow: 0 0 30px #51CF66;
        }

        .judgment-miss {
            color: #FF6B6B;
            text-shadow: 0 0 30px #FF6B6B;
        }

        /* è™šæ‹Ÿé’¢ç´é”®ç›˜ */
        .virtual-piano {
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
        }

        .piano-keys {
            display: flex;
            position: relative;
            height: 150px;
        }

        .piano-key {
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 0.9em;
            font-weight: bold;
            border: 2px solid rgba(0,0,0,0.3);
        }

        .white-key {
            width: 50px;
            height: 150px;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border-radius: 0 0 5px 5px;
            color: #666;
            z-index: 1;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #FFD700 0%, #FFA500 100%);
            transform: translateY(3px);
            box-shadow: 0 0 20px rgba(255,215,0,0.8);
        }

        .black-key {
            width: 30px;
            height: 100px;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border-radius: 0 0 3px 3px;
            color: white;
            position: absolute;
            z-index: 2;
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #444 0%, #111 100%);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #FFD700 0%, #FFA500 100%);
            transform: translateY(3px);
            box-shadow: 0 0 20px rgba(255,215,0,0.8);
        }

        /* å¼€å§‹ç•Œé¢ */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
        }

        .start-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .start-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            max-width: 600px;
        }

        .song-selector {
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
        }

        .song-selector label {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
            text-align: center;
        }

        .song-selector select {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #FFD700;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            color: #333;
        }

        .difficulty-selector {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
        }

        .difficulty-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: 2px solid #FFD700;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn:hover {
            background: rgba(255,215,0,0.3);
        }

        .difficulty-btn.active {
            background: #FFD700;
            color: #333;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            max-width: 600px;
            text-align: left;
        }

        .instructions h3 {
            margin-bottom: 15px;
            color: #FFD700;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }

        .instructions li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #FFD700;
        }

        /* ç»“æŸç•Œé¢ */
        .end-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
        }

        .end-screen.show {
            display: flex;
        }

        .end-screen h2 {
            font-size: 3em;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .stats-display {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            min-width: 400px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.3em;
        }

        .stat-label {
            opacity: 0.8;
        }

        .stat-value {
            font-weight: bold;
            color: #FFD700;
        }

        .achievements {
            margin-bottom: 30px;
            text-align: center;
        }

        .achievement-badge {
            display: inline-block;
            background: rgba(255,215,0,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            margin: 5px;
            border: 2px solid #FFD700;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .game-header {
                padding: 10px 15px;
            }

            .score-display {
                gap: 15px;
            }

            .score-value {
                font-size: 1.3em;
            }

            .btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .start-screen h1 {
                font-size: 2em;
            }

            .piano-keys {
                height: 120px;
            }

            .white-key {
                width: 40px;
                height: 120px;
            }

            .black-key {
                width: 25px;
                height: 80px;
            }

            .stats-display {
                min-width: auto;
                width: 100%;
            }

            .judgment-display {
                font-size: 3em;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            z-index: 300;
        }

        .spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ  -->
    <nav class="main-nav">
        <div class="main-nav-container">
            <a href="./index.html" class="main-nav-logo">
                <span>ğŸ¹</span>
                <span>åœ¨çº¿é’¢ç´</span>
            </a>
            <button class="main-nav-toggle" onclick="document.querySelector('.main-nav-menu').classList.toggle('active')">
                â˜°
            </button>
            <ul class="main-nav-menu">
                <li><a href="./index.html">ğŸ  ä¸»é¡µ</a></li>
                <li><a href="./follow-along.html">ğŸ“š è·Ÿå¼¹æ¨¡å¼</a></li>
                <li><a href="./game-mode.html" class="active">ğŸ® æ¸¸æˆæ¨¡å¼</a></li>
            </ul>
        </div>
    </nav>

    <div class="game-container">
        <!-- å¼€å§‹ç•Œé¢ -->
        <div class="start-screen" id="startScreen">
            <h1>ğŸ® é’¢ç´èŠ‚å¥æ¸¸æˆ</h1>
            <p>åƒç©æ¸¸æˆä¸€æ ·å­¦é’¢ç´ï¼éŸ³ç¬¦ä»ä¸Šæ–¹è½ä¸‹ï¼Œåœ¨å®ƒä»¬åˆ°è¾¾åˆ¤å®šçº¿æ—¶æŒ‰ä¸‹æ­£ç¡®çš„ç´é”®ã€‚</p>
            
            <div class="song-selector">
                <label for="songSelect">ğŸµ é€‰æ‹©æ­Œæ›²ï¼š</label>
                <select id="songSelect">
                    <option value="">-- è¯·é€‰æ‹©ä¸€é¦–æ­Œæ›² --</option>
                    <option value="ç®€å•çˆ±">ç®€å•çˆ± - å‘¨æ°ä¼¦</option>
                    <option value="å‘Šç™½æ°”çƒ">å‘Šç™½æ°”çƒ - å‘¨æ°ä¼¦</option>
                    <option value="ä¸ƒé‡Œé¦™">ä¸ƒé‡Œé¦™ - å‘¨æ°ä¼¦</option>
                    <option value="æˆéƒ½">æˆéƒ½ - èµµé›·</option>
                    <option value="çº¸çŸ­æƒ…é•¿">çº¸çŸ­æƒ…é•¿ - çƒŸæŠŠå„¿</option>
                    <option value="åƒä¸åƒå¯»">åƒä¸åƒå¯» - ä¹…çŸ³è®©</option>
                    <option value="one_summers_day">One Summer's Day</option>
                    <option value="canon">Canon in D - å¡å†œ</option>
                </select>
            </div>

            <div class="difficulty-selector">
                <button class="difficulty-btn" data-difficulty="easy">ç®€å•</button>
                <button class="difficulty-btn active" data-difficulty="normal">æ™®é€š</button>
                <button class="difficulty-btn" data-difficulty="hard">å›°éš¾</button>
            </div>

            <div class="instructions">
                <h3>ğŸ“– æ¸¸æˆè¯´æ˜</h3>
                <ul>
                    <li>éŸ³ç¬¦ä¼šä»ä¸Šæ–¹è½ä¸‹ï¼Œåœ¨åˆ°è¾¾åº•éƒ¨åˆ¤å®šçº¿æ—¶æŒ‰é”®</li>
                    <li>Perfectï¼šæ—¶æœºå®Œç¾ï¼+100åˆ†</li>
                    <li>Goodï¼šä¸é”™ï¼+50åˆ†</li>
                    <li>Missï¼šå¤±è¯¯ï¼Œè¿å‡»æ¸…é›¶</li>
                    <li>é”®ç›˜æ˜ å°„ï¼šA-L ä¸ºç™½é”®ï¼ŒW-P ä¸ºé»‘é”®</li>
                    <li>ä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»/è§¦æ‘¸åº•éƒ¨çš„è™šæ‹Ÿé’¢ç´é”®ç›˜</li>
                    <li>ä¿æŒè¿å‡»è·å¾—æ›´é«˜åˆ†æ•°ï¼</li>
                </ul>
            </div>

            <button class="btn btn-primary btn-lg" id="startGameBtn" style="font-size:1.5em; padding:20px 50px;" disabled>å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="game-header">
            <div class="score-display">
                <div class="score-item">
                    <span class="score-label">åˆ†æ•°</span>
                    <span class="score-value" id="scoreDisplay">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">è¿å‡»</span>
                    <span class="score-value combo-value" id="comboDisplay">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">å‡†ç¡®ç‡</span>
                    <span class="score-value accuracy-value" id="accuracyDisplay">100%</span>
                </div>
            </div>
            <div class="game-controls">
                <button class="btn btn-secondary" id="pauseBtn" disabled>æš‚åœ</button>
                <button class="btn btn-danger" id="quitBtn">é€€å‡º</button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0</div>
        </div>

        <div class="game-canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            <div class="judgment-display" id="judgmentDisplay"></div>
        </div>

        <div class="virtual-piano" id="virtualPiano">
            <!-- é’¢ç´é”®ç›˜å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- ç»“æŸç•Œé¢ -->
        <div class="end-screen" id="endScreen">
            <h2>ğŸ‰ æ¸¸æˆç»“æŸï¼</h2>
            <div class="stats-display">
                <div class="stat-row">
                    <span class="stat-label">æœ€ç»ˆåˆ†æ•°</span>
                    <span class="stat-value" id="finalScore">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">æœ€å¤§è¿å‡»</span>
                    <span class="stat-value" id="maxCombo">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">å‡†ç¡®ç‡</span>
                    <span class="stat-value" id="finalAccuracy">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Perfect</span>
                    <span class="stat-value" id="perfectCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Good</span>
                    <span class="stat-value" id="goodCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Miss</span>
                    <span class="stat-value" id="missCount">0</span>
                </div>
            </div>
            <div class="achievements" id="achievements"></div>
            <div style="display:flex; gap:15px;">
                <button class="btn btn-primary" id="restartBtn">å†ç©ä¸€æ¬¡</button>
                <button class="btn btn-secondary" id="changeSongBtn">æ¢é¦–æ­Œ</button>
                <button class="btn btn-danger" id="backHomeBtn">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    </div>

    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    
    <script>
        // ==================== æ¸¸æˆé…ç½® ====================
        const CONFIG = {
            easy: {
                speed: 150,         // åƒç´ /ç§’
                perfectWindow: 80,  // ms
                goodWindow: 150,    // ms
                noteLimit: 50       // åªå–å‰Nä¸ªéŸ³ç¬¦
            },
            normal: {
                speed: 200,
                perfectWindow: 60,
                goodWindow: 120,
                noteLimit: 100
            },
            hard: {
                speed: 250,
                perfectWindow: 40,
                goodWindow: 100,
                noteLimit: null     // å…¨éƒ¨éŸ³ç¬¦
            }
        };

        // éŸ³ç¬¦åˆ°ç´é”®çš„æ˜ å°„
        const NOTE_TO_KEY_MAP = {
            'C4': { lane: 0, isBlack: false, key: 'a', display: 'Do' },
            'D4': { lane: 1, isBlack: false, key: 's', display: 'Re' },
            'E4': { lane: 2, isBlack: false, key: 'd', display: 'Mi' },
            'F4': { lane: 3, isBlack: false, key: 'f', display: 'Fa' },
            'G4': { lane: 4, isBlack: false, key: 'g', display: 'Sol' },
            'A4': { lane: 5, isBlack: false, key: 'h', display: 'La' },
            'B4': { lane: 6, isBlack: false, key: 'j', display: 'Si' },
            'C5': { lane: 7, isBlack: false, key: 'k', display: 'Do' },
            'D5': { lane: 8, isBlack: false, key: 'l', display: 'Re' },
            'C#4': { lane: 0.5, isBlack: true, key: 'w', display: 'C#' },
            'D#4': { lane: 1.5, isBlack: true, key: 'e', display: 'D#' },
            'F#4': { lane: 3.5, isBlack: true, key: 't', display: 'F#' },
            'G#4': { lane: 4.5, isBlack: true, key: 'y', display: 'G#' },
            'A#4': { lane: 5.5, isBlack: true, key: 'u', display: 'A#' },
            'C#5': { lane: 7.5, isBlack: true, key: 'o', display: 'C#' },
            'D#5': { lane: 8.5, isBlack: true, key: 'p', display: 'D#' }
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {
            isPlaying: false,
            isPaused: false,
            startTime: 0,
            currentTime: 0,
            score: 0,
            combo: 0,
            maxCombo: 0,
            perfect: 0,
            good: 0,
            miss: 0,
            notes: [],
            judgedNotes: new Set(),
            selectedSong: '',
            difficulty: 'normal',
            songData: null
        };

        // ==================== éŸ³é¢‘å¼•æ“ ====================
        const sampler = new Tone.Sampler({
            urls: {
                C4: "C4.mp3", D4: "D4.mp3", E4: "E4.mp3", F4: "F4.mp3",
                G4: "G4.mp3", A4: "A4.mp3", B4: "B4.mp3", C5: "C5.mp3", D5: "D5.mp3"
            },
            baseUrl: "./static/samples/piano/",
            onload: () => {
                console.log('Piano samples loaded');
            }
        }).toDestination();

        // ==================== DOM å…ƒç´  ====================
        const startScreen = document.getElementById('startScreen');
        const endScreen = document.getElementById('endScreen');
        const songSelect = document.getElementById('songSelect');
        const startGameBtn = document.getElementById('startGameBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const quitBtn = document.getElementById('quitBtn');
        const restartBtn = document.getElementById('restartBtn');
        const changeSongBtn = document.getElementById('changeSongBtn');
        const backHomeBtn = document.getElementById('backHomeBtn');
        
        const scoreDisplay = document.getElementById('scoreDisplay');
        const comboDisplay = document.getElementById('comboDisplay');
        const accuracyDisplay = document.getElementById('accuracyDisplay');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const judgmentDisplay = document.getElementById('judgmentDisplay');

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const virtualPiano = document.getElementById('virtualPiano');

        // ==================== Canvas è®¾ç½® ====================
        function resizeCanvas() {
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== éš¾åº¦é€‰æ‹© ====================
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gameState.difficulty = btn.dataset.difficulty;
            });
        });

        // ==================== æ­Œæ›²é€‰æ‹© ====================
        songSelect.addEventListener('change', (e) => {
            gameState.selectedSong = e.target.value;
            startGameBtn.disabled = !gameState.selectedSong;
        });

        // ==================== åŠ è½½æ­Œæ›²æ•°æ® ====================
        async function loadSongData(songName) {
            try {
                const response = await fetch(`./static/xmlscore/${songName}.json`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to load song:', error);
                alert('åŠ è½½æ­Œæ›²å¤±è´¥ï¼');
                return null;
            }
        }

        // ==================== è§£ææ­Œæ›²ä¸ºæ¸¸æˆéŸ³ç¬¦ ====================
        function parseSongToNotes(songData, difficulty) {
            const notes = [];
            const config = CONFIG[difficulty];
            let currentTime = 0;
            
            // åªå– staff1 voice1 çš„ä¸»æ—‹å¾‹
            songData.measures.forEach(measure => {
                if (measure.staff1 && measure.staff1.voice1) {
                    measure.staff1.voice1.forEach(note => {
                        if (!note.rest && note.noteName && NOTE_TO_KEY_MAP[note.noteName]) {
                            const mapping = NOTE_TO_KEY_MAP[note.noteName];
                            notes.push({
                                pitch: note.noteName,
                                startTime: currentTime / 1000, // è½¬æ¢ä¸ºç§’
                                duration: note.duration / 1000,
                                lane: mapping.lane,
                                isBlack: mapping.isBlack,
                                key: mapping.key,
                                judged: false,
                                y: 0 // æ¸²æŸ“ä½ç½®
                            });
                        }
                        currentTime += note.duration;
                    });
                }
            });

            // æ ¹æ®éš¾åº¦é™åˆ¶éŸ³ç¬¦æ•°é‡
            if (config.noteLimit && notes.length > config.noteLimit) {
                return notes.slice(0, config.noteLimit);
            }
            
            return notes;
        }

        // ==================== ç”Ÿæˆè™šæ‹Ÿé’¢ç´é”®ç›˜ ====================
        function generateVirtualPiano() {
            virtualPiano.innerHTML = '<div class="piano-keys" id="pianoKeys"></div>';
            const pianoKeys = document.getElementById('pianoKeys');
            
            // ç™½é”®
            const whiteKeys = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5'];
            whiteKeys.forEach(note => {
                const mapping = NOTE_TO_KEY_MAP[note];
                const key = document.createElement('div');
                key.className = 'piano-key white-key';
                key.dataset.note = note;
                key.dataset.key = mapping.key;
                key.innerHTML = `<div>${mapping.display}<br><small>${mapping.key.toUpperCase()}</small></div>`;
                key.addEventListener('mousedown', () => onKeyPress(note));
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    onKeyPress(note);
                });
                pianoKeys.appendChild(key);
            });

            // é»‘é”®
            const blackKeys = [
                { note: 'C#4', left: 35 },
                { note: 'D#4', left: 85 },
                { note: 'F#4', left: 185 },
                { note: 'G#4', left: 235 },
                { note: 'A#4', left: 285 },
                { note: 'C#5', left: 385 },
                { note: 'D#5', left: 435 }
            ];
            
            blackKeys.forEach(({ note, left }) => {
                if (NOTE_TO_KEY_MAP[note]) {
                    const mapping = NOTE_TO_KEY_MAP[note];
                    const key = document.createElement('div');
                    key.className = 'piano-key black-key';
                    key.style.left = left + 'px';
                    key.dataset.note = note;
                    key.dataset.key = mapping.key;
                    key.innerHTML = `<div>${mapping.display}<br><small>${mapping.key.toUpperCase()}</small></div>`;
                    key.addEventListener('mousedown', () => onKeyPress(note));
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        onKeyPress(note);
                    });
                    pianoKeys.appendChild(key);
                }
            });
        }

        generateVirtualPiano();

        // ==================== é”®ç›˜äº‹ä»¶ ====================
        document.addEventListener('keydown', (e) => {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            const key = e.key.toLowerCase();
            // æ‰¾åˆ°å¯¹åº”çš„éŸ³ç¬¦
            for (const [note, mapping] of Object.entries(NOTE_TO_KEY_MAP)) {
                if (mapping.key === key) {
                    onKeyPress(note);
                    break;
                }
            }
        });

        // ==================== æŒ‰é”®å¤„ç† ====================
        function onKeyPress(note) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            // æ’­æ”¾å£°éŸ³
            sampler.triggerAttackRelease(note, '8n');
            
            // è§†è§‰åé¦ˆ
            highlightKey(note);
            
            // åˆ¤å®š
            judgeNote(note);
        }

        function highlightKey(note) {
            const key = document.querySelector(`[data-note="${note}"]`);
            if (key) {
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 200);
            }
        }

        // ==================== éŸ³ç¬¦åˆ¤å®š ====================
        function judgeNote(pressedNote) {
            const now = (Date.now() - gameState.startTime) / 1000;
            const config = CONFIG[gameState.difficulty];
            
            // æ‰¾åˆ°è¯¥éŸ³ç¬¦æœ€è¿‘çš„ã€æœªåˆ¤å®šçš„ note
            let closestNote = null;
            let minDelta = Infinity;
            
            for (const note of gameState.notes) {
                if (note.judged || note.pitch !== pressedNote) continue;
                
                const delta = Math.abs(note.startTime - now);
                const timeWindow = config.goodWindow / 1000;
                
                if (delta < timeWindow && delta < minDelta) {
                    minDelta = delta;
                    closestNote = note;
                }
            }
            
            if (!closestNote) return;
            
            closestNote.judged = true;
            gameState.judgedNotes.add(closestNote);
            
            const deltaMs = minDelta * 1000;
            
            if (deltaMs <= config.perfectWindow) {
                // Perfect
                gameState.perfect++;
                gameState.combo++;
                gameState.score += 100;
                showJudgment('PERFECT', 'perfect');
            } else if (deltaMs <= config.goodWindow) {
                // Good
                gameState.good++;
                gameState.combo++;
                gameState.score += 50;
                showJudgment('GOOD', 'good');
            } else {
                // Miss
                gameState.miss++;
                gameState.combo = 0;
                showJudgment('MISS', 'miss');
            }
            
            gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
            updateUI();
        }

        function showJudgment(text, type) {
            judgmentDisplay.textContent = text;
            judgmentDisplay.className = `judgment-display judgment-${type}`;
            judgmentDisplay.style.opacity = '1';
            judgmentDisplay.style.animation = 'none';
            
            setTimeout(() => {
                judgmentDisplay.style.animation = 'judgmentPop 0.5s ease-out';
            }, 10);
        }

        // ==================== è‡ªåŠ¨åˆ¤å®š Miss ====================
        function checkMissedNotes() {
            const now = (Date.now() - gameState.startTime) / 1000;
            const config = CONFIG[gameState.difficulty];
            const missWindow = config.goodWindow / 1000;
            
            for (const note of gameState.notes) {
                if (note.judged) continue;
                
                if (now - note.startTime > missWindow) {
                    note.judged = true;
                    gameState.judgedNotes.add(note);
                    gameState.miss++;
                    gameState.combo = 0;
                    showJudgment('MISS', 'miss');
                    updateUI();
                }
            }
        }

        // ==================== æ›´æ–° UI ====================
        function updateUI() {
            scoreDisplay.textContent = gameState.score;
            comboDisplay.textContent = gameState.combo;
            
            const totalJudged = gameState.perfect + gameState.good + gameState.miss;
            const accuracy = totalJudged > 0 
                ? ((gameState.perfect + gameState.good) / totalJudged * 100).toFixed(1)
                : 100;
            accuracyDisplay.textContent = accuracy + '%';
            
            const progress = totalJudged / gameState.notes.length * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = `${totalJudged} / ${gameState.notes.length}`;
        }

        // ==================== æ¸¸æˆå¾ªç¯ ====================
        function gameLoop() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            const now = (Date.now() - gameState.startTime) / 1000;
            gameState.currentTime = now;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶åˆ¤å®šçº¿
            const judgeLineY = canvas.height - 150;
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, judgeLineY);
            ctx.lineTo(canvas.width, judgeLineY);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸‹è½éŸ³ç¬¦
            const config = CONFIG[gameState.difficulty];
            const speed = config.speed;
            const laneWidth = 50;
            const startX = (canvas.width - laneWidth * 9) / 2;
            
            for (const note of gameState.notes) {
                if (note.judged) continue;
                
                const timeDiff = note.startTime - now;
                const y = judgeLineY - timeDiff * speed;
                
                // åªæ¸²æŸ“å¯è§èŒƒå›´å†…çš„éŸ³ç¬¦
                if (y < -100 || y > canvas.height) continue;
                
                const x = startX + note.lane * laneWidth;
                const width = note.isBlack ? 30 : 40;
                const height = Math.max(note.duration * speed, 20);
                
                // ç»˜åˆ¶éŸ³ç¬¦
                ctx.fillStyle = note.isBlack 
                    ? 'rgba(100, 100, 255, 0.9)' 
                    : 'rgba(255, 100, 150, 0.9)';
                ctx.shadowColor = note.isBlack ? '#6464ff' : '#ff6496';
                ctx.shadowBlur = 10;
                ctx.fillRect(x - width/2, y - height, width, height);
                ctx.shadowBlur = 0;
                
                // ç»˜åˆ¶éŸ³ç¬¦åç§°
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(note.pitch, x, y - height/2);
            }
            
            // æ£€æŸ¥æ¼æ‰çš„éŸ³ç¬¦
            checkMissedNotes();
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (gameState.judgedNotes.size >= gameState.notes.length) {
                endGame();
                return;
            }
            
            requestAnimationFrame(gameLoop);
        }

        // ==================== å¼€å§‹æ¸¸æˆ ====================
        startGameBtn.addEventListener('click', async () => {
            if (!gameState.selectedSong) return;
            
            // åŠ è½½æ­Œæ›²æ•°æ®
            const songData = await loadSongData(gameState.selectedSong);
            if (!songData) return;
            
            gameState.songData = songData;
            gameState.notes = parseSongToNotes(songData, gameState.difficulty);
            
            if (gameState.notes.length === 0) {
                alert('è¿™é¦–æ­Œæ²¡æœ‰å¯ç”¨çš„éŸ³ç¬¦ï¼');
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.perfect = 0;
            gameState.good = 0;
            gameState.miss = 0;
            gameState.judgedNotes.clear();
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.startTime = Date.now() + 2000; // 2ç§’å‡†å¤‡æ—¶é—´
            
            // éšè—å¼€å§‹ç•Œé¢
            startScreen.style.display = 'none';
            pauseBtn.disabled = false;
            
            // å¯åŠ¨ Tone.js
            await Tone.start();
            
            // å€’è®¡æ—¶
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    showJudgment(countdown.toString(), 'perfect');
                } else if (countdown === 0) {
                    showJudgment('GO!', 'perfect');
                    clearInterval(countdownInterval);
                    updateUI();
                    gameLoop();
                }
            }, 1000);
        });

        // ==================== æš‚åœ/ç»§ç»­ ====================
        pauseBtn.addEventListener('click', () => {
            if (gameState.isPaused) {
                // ç»§ç»­
                gameState.isPaused = false;
                gameState.startTime += Date.now() - gameState.pauseTime;
                pauseBtn.textContent = 'æš‚åœ';
                gameLoop();
            } else {
                // æš‚åœ
                gameState.isPaused = true;
                gameState.pauseTime = Date.now();
                pauseBtn.textContent = 'ç»§ç»­';
            }
        });

        // ==================== é€€å‡º ====================
        quitBtn.addEventListener('click', () => {
            if (gameState.isPlaying && confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                endGame(true);
            }
        });

        // ==================== ç»“æŸæ¸¸æˆ ====================
        function endGame(isQuit = false) {
            gameState.isPlaying = false;
            pauseBtn.disabled = true;
            
            if (isQuit) {
                startScreen.style.display = 'flex';
                return;
            }
            
            // æ˜¾ç¤ºç»“æŸç•Œé¢
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('maxCombo').textContent = gameState.maxCombo;
            document.getElementById('perfectCount').textContent = gameState.perfect;
            document.getElementById('goodCount').textContent = gameState.good;
            document.getElementById('missCount').textContent = gameState.miss;
            
            const totalNotes = gameState.perfect + gameState.good + gameState.miss;
            const accuracy = totalNotes > 0 
                ? ((gameState.perfect + gameState.good) / totalNotes * 100).toFixed(1)
                : 0;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            
            // æ˜¾ç¤ºæˆå°±
            const achievements = [];
            if (accuracy >= 95) achievements.push('ğŸ† å®Œç¾æ¼”å¥');
            if (gameState.maxCombo >= 50) achievements.push('ğŸ”¥ è¿å‡»å¤§å¸ˆ');
            if (gameState.perfect >= totalNotes * 0.8) achievements.push('â­ ç²¾å‡†ä¹‹ç¥');
            if (gameState.score >= 5000) achievements.push('ğŸ’ é«˜åˆ†è¾¾äºº');
            
            const achievementsDiv = document.getElementById('achievements');
            if (achievements.length > 0) {
                achievementsDiv.innerHTML = '<h3>ğŸ–ï¸ æˆå°±è§£é”</h3>' + 
                    achievements.map(a => `<div class="achievement-badge">${a}</div>`).join('');
            } else {
                achievementsDiv.innerHTML = '';
            }
            
            // ä¿å­˜æœ€é«˜åˆ†
            const storageKey = `highscore_${gameState.selectedSong}_${gameState.difficulty}`;
            const highScore = localStorage.getItem(storageKey) || 0;
            if (gameState.score > highScore) {
                localStorage.setItem(storageKey, gameState.score);
            }
            
            endScreen.classList.add('show');
        }

        // ==================== é‡æ–°å¼€å§‹ ====================
        restartBtn.addEventListener('click', () => {
            endScreen.classList.remove('show');
            startGameBtn.click();
        });

        // ==================== æ¢é¦–æ­Œ ====================
        changeSongBtn.addEventListener('click', () => {
            endScreen.classList.remove('show');
            startScreen.style.display = 'flex';
            gameState.isPlaying = false;
        });

        // ==================== è¿”å›ä¸»é¡µ ====================
        backHomeBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
